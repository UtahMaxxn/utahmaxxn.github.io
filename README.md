<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST</title>
    <style>
        /* FONT IMPORT (Material Symbols) */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200');

        :root {
            /* Dynamically generated by JS */
            --primary-color: #6750a4; --primary-container: #eaddff; --on-primary-container: #21005d;
            --tertiary-container: #ffd8e4; --on-tertiary-container: #31111d; --surface-container-low: #f7f2fa;
            --surface-container: #f3edf7; --surface-container-high: #eeebf4; --on-surface: #1d1b20;
            --on-surface-variant: #49454f; --outline: #79747e; --background: #fef7ff;
            --on-background: #1d1b20; --shadow: rgba(0, 0, 0, 0.1);
            --animation-speed: 0.25s; --animation-curve: cubic-bezier(0.2, 0, 0, 1); --backdrop-blur: 16px;
        }
        .dark-mode { --shadow: rgba(0, 0, 0, 0.3); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background); color: var(--on-background); overflow: hidden; user-select: none; transition: background-color var(--animation-speed) ease; }
        .window-body, .files-main { scrollbar-width: thin; scrollbar-color: var(--outline) transparent; }
        .window-body::-webkit-scrollbar, .files-main::-webkit-scrollbar { width: 8px; }
        .window-body::-webkit-scrollbar-track, .files-main::-webkit-scrollbar-track { background: transparent; }
        .window-body::-webkit-scrollbar-thumb, .files-main::-webkit-scrollbar-thumb { background-color: var(--outline); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        #desktop { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background-size: cover; background-position: center; transition: background-image 0.5s ease; }
        #taskbar { position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); width: max-content; height: 56px; background-color: rgba(var(--surface-container-high-rgb), 0.7); backdrop-filter: blur(var(--backdrop-blur)); border-radius: 28px; box-shadow: 0 4px 30px var(--shadow); border: 1px solid rgba(var(--outline-rgb), 0.2); display: flex; align-items: center; padding: 0 8px; gap: 8px; z-index: 10000; }
        #startButton, #clock, .taskbar-app { transition: background-color var(--animation-speed) ease; }
        #startButton, #clock { padding: 0 16px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 20px; cursor: pointer; }
        #startButton:hover, .taskbar-app:hover { background-color: rgba(var(--on-surface-rgb), 0.08); }
        #startButton.active { background-color: var(--primary-container); color: var(--on-primary-container); }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        #taskbar-apps { display: flex; align-items: center; gap: 8px; }
        .taskbar-app { width: 40px; height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; position: relative; }
        .taskbar-app .taskbar-icon { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .taskbar-app.active::after { content: ''; position: absolute; bottom: 0px; width: 16px; height: 4px; background-color: var(--primary-color); border-radius: 2px; }
        .taskbar-app .app-count-badge { position: absolute; top: 0; right: 0; font-size: 10px; background-color: var(--primary-color); color: var(--primary-container); border-radius: 50%; width: 16px; height: 16px; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        #clock { font-size: 14px; font-weight: 500; color: var(--on-surface-variant); }
        #startMenu { position: fixed; bottom: 72px; left: 50%; transform: translate(-50%, 20px); width: 500px; max-width: 90vw; height: 550px; background-color: rgba(var(--surface-container-low-rgb), 0.75); backdrop-filter: blur(var(--backdrop-blur)); border-radius: 24px; box-shadow: 0 4px 30px var(--shadow); border: 1px solid rgba(var(--outline-rgb), 0.2); z-index: 9999; opacity: 0; visibility: hidden; transition: transform var(--animation-speed) var(--animation-curve), opacity var(--animation-speed) ease; padding: 16px; display: flex; flex-direction: column; }
        #startMenu.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
        #search-box { width: 100%; height: 56px; background-color: rgba(var(--surface-container-rgb), 0.7); border: none; border-radius: 28px; padding: 0 24px; font-size: 16px; color: var(--on-surface-variant); outline: none; }
        #search-box::placeholder { color: var(--on-surface-variant); }
        .app-grid { margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 16px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px; border-radius: 12px; cursor: pointer; transition: background-color var(--animation-speed) ease; text-align: center; }
        .app-icon:hover { background-color: rgba(var(--on-surface-rgb), 0.08); }
        .app-icon .icon-bg { width: 56px; height: 56px; border-radius: 50%; background-color: var(--surface-container); display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .app-icon .icon-bg .material-symbols-outlined { color: var(--on-surface-variant); font-size: 28px; }
        .app-icon span { font-size: 12px; color: var(--on-surface); }
        .window { position: absolute; min-width: 350px; min-height: 250px; background-color: rgba(var(--surface-container-rgb), 0.8); backdrop-filter: blur(var(--backdrop-blur)); border-radius: 16px; box-shadow: 0 8px 30px var(--shadow); display: flex; flex-direction: column; overflow: hidden; resize: both; transform-origin: center; animation: open-window var(--animation-speed) var(--animation-curve); }
        @keyframes open-window { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .window.closing { animation: close-window var(--animation-speed) var(--animation-curve) forwards; }
        @keyframes close-window { from { transform: scale(1); opacity: 1; } to { transform: scale(0.9); opacity: 0; } }
        .window.maximized { top: 0 !important; left: 0 !important; width: 100% !important; height: calc(100% - 72px) !important; border-radius: 0; resize: none; }
        .window.minimized {
            animation: minimize-window var(--animation-speed) var(--animation-curve) forwards;
        }
        @keyframes minimize-window {
            to {
                transform: scale(0.2);
                opacity: 0;
                top: calc(100% - 66px);
                left: 50%;
                width: 40px;
                height: 40px;
            }
        }
        .window.restoring {
            animation: restore-window var(--animation-speed) var(--animation-curve) forwards;
        }
        @keyframes restore-window {
            from {
                transform: scale(0.2);
                opacity: 0;
                top: calc(100% - 66px);
                left: 50%;
                width: 40px;
                height: 40px;
            }
        }
        .title-bar { height: 48px; display: flex; align-items: center; padding: 0 8px 0 16px; cursor: grab; flex-shrink: 0; border-bottom: 1px solid rgba(var(--outline-rgb), 0.3); }
        .title-bar:active { cursor: grabbing; }
        .title-bar-icon { margin-right: 8px; font-size: 20px; color: var(--on-surface-variant); }
        .title-bar-text { flex-grow: 1; font-weight: 500; }
        .window-controls { display: flex; }
        .window-control { width: 28px; height: 28px; border: none; background: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--on-surface-variant); transition: background-color 0.1s ease; }
        .window-control .material-symbols-outlined { font-size: 18px; }
        .window-control:hover { background-color: rgba(var(--on-surface-rgb), 0.1); }
        .window-control.close-btn:hover { background-color: #e53935; color: white; }
        .window-body { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        #contextMenu { position: fixed; z-index: 10001; width: 220px; background-color: rgba(var(--surface-container-low-rgb), 0.8); backdrop-filter: blur(var(--backdrop-blur)); border-radius: 8px; padding: 8px; box-shadow: 0 4px 20px var(--shadow); border: 1px solid rgba(var(--outline-rgb), 0.2); opacity: 0; transform: scale(0.95); transform-origin: top left; transition: opacity 0.1s ease, transform 0.1s ease; visibility: hidden; }
        #contextMenu.visible { opacity: 1; transform: scale(1); visibility: visible; }
        #contextMenu ul { list-style: none; }
        #contextMenu li { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        #contextMenu li:hover { background-color: rgba(var(--on-surface-rgb), 0.08); }
        hr { border: none; height: 1px; background-color: var(--outline); opacity: 0.2; margin: 4px 0; }
        .texts-app { padding: 16px; flex-grow: 1; }
        .texts-app textarea { width: 100%; height: 100%; border: none; background-color: transparent; resize: none; outline: none; font-family: 'Roboto', sans-serif; font-size: 16px; line-height: 1.5; color: var(--on-surface); user-select: text; }
        .settings-app { padding: 16px; display: flex; flex-direction: column; gap: 24px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; }
        .setting-item label { font-weight: 500; }
        .color-palette { display: flex; gap: 8px; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s ease; }
        .color-dot.active { border-color: var(--primary-color); }
        .switch { position: relative; display: inline-block; width: 52px; height: 32px; }
        .switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--surface-container); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: var(--outline); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .numbers-app { padding: 16px; display: flex; flex-direction: column; height: 100%; }
        .calculator-display { flex: 1; background-color: transparent; border-radius: 12px; padding: 16px; text-align: right; font-size: 40px; font-weight: 300; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .calculator-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 16px; }
        .calc-btn { height: 60px; border-radius: 30px; border: none; font-size: 20px; cursor: pointer; background-color: rgba(var(--surface-container-high-rgb), 0.5); color: var(--on-surface); transition: background-color 0.1s ease; }
        .calc-btn:hover { background-color: rgba(var(--surface-container-high-rgb), 0.8); }
        .calc-btn.operator { background-color: var(--tertiary-container); color: var(--on-tertiary-container); }
        .calc-btn.equals { background-color: var(--primary-container); color: var(--on-primary-container); grid-column: span 2; }
        
        /* --- REBUILT FILES APP STYLES --- */
        .files-app { display: flex; flex-direction: column; height: 100%; }
        .files-toolbar { display: flex; align-items: center; gap: 4px; padding: 8px; border-bottom: 1px solid rgba(var(--outline-rgb), 0.3); flex-shrink: 0; }
        .files-content-area { display: flex; flex-direction: row; flex-grow: 1; overflow: hidden; }
        .files-sidebar { width: 200px; flex-shrink: 0; padding: 8px; border-right: 1px solid rgba(var(--outline-rgb), 0.3); overflow-y: auto; }
        .sidebar-item { padding: 8px 12px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 4px; font-size: 14px; }
        .sidebar-item:hover { background-color: rgba(var(--on-surface-rgb), 0.08); }
        .sidebar-item.active { background-color: var(--primary-container); color: var(--on-primary-container); }
        .toolbar-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: none; cursor: pointer; color: var(--on-surface-variant); display: flex; align-items: center; justify-content: center; }
        .toolbar-btn:hover { background-color: rgba(var(--on-surface-rgb), 0.08); }
        .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .path-bar { flex-grow: 1; display: flex; align-items: center; gap: 4px; background-color: var(--surface-container-high); border-radius: 18px; height: 36px; padding: 0 8px; }
        .path-segment { padding: 4px 8px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .path-segment:hover { background-color: rgba(var(--on-surface-rgb), 0.12); }
        .path-separator { color: var(--on-surface-variant); }
        .view-toggle { display: flex; border: 1px solid var(--outline); border-radius: 18px; overflow: hidden; }
        .view-toggle .toolbar-btn { border-radius: 0; width: 40px; }
        .view-toggle .toolbar-btn.active { background-color: var(--primary-container); color: var(--on-primary-container); }
        .file-view-container { flex-grow: 1; overflow-y: auto; padding: 8px; }
        .file-grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 16px; align-content: flex-start; }
        .file-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 8px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; }
        .file-item:hover { background-color: rgba(var(--on-surface-rgb), 0.08); }
        .file-item.selected { background-color: rgba(var(--primary-color), 0.12); border-color: var(--primary-color); }
        .file-item .material-symbols-outlined { font-size: 48px; color: var(--primary-color); }
        .file-item span { font-size: 12px; word-break: break-all; margin-top: 4px; }
        .file-list-view { display: flex; flex-direction: column; gap: 4px; }
        .file-list-item { display: grid; grid-template-columns: 32px 1fr 100px; align-items: center; gap: 12px; padding: 6px 12px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .file-list-item:hover { background-color: rgba(var(--on-surface-rgb), 0.08); }
        .file-list-item.selected { background-color: rgba(var(--primary-color), 0.12); border-color: var(--primary-color); }
        .file-list-item .material-symbols-outlined { font-size: 24px; color: var(--primary-color); }
        .file-list-item .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; }
        .file-list-item .file-type { font-size: 12px; color: var(--on-surface-variant); text-align: right; }
        .files-details-pane { width: 250px; flex-shrink: 0; border-left: 1px solid rgba(var(--outline-rgb), 0.3); padding: 16px; overflow-y: auto; }
        .details-placeholder, .details-content { display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%; justify-content: center; color: var(--on-surface-variant); }
        .details-placeholder .material-symbols-outlined { font-size: 48px; margin-bottom: 8px; }
        .details-content .material-symbols-outlined { font-size: 64px; margin-bottom: 16px; color: var(--primary-color); }
        .details-content h4 { margin-bottom: 16px; word-break: break-word; }
        .details-content dl { font-size: 12px; text-align: left; width: 100%; }
        .details-content dt { font-weight: 500; color: var(--on-surface-variant); float: left; width: 60px; clear: left; }
        .details-content dd { margin-left: 60px; margin-bottom: 8px; word-break: break-all; }
        .details-preview { max-width: 100%; border-radius: 8px; margin-top: 16px; }

        .photos-app { padding: 8px; display: flex; justify-content: center; align-items: center; flex-grow: 1;}
        .photos-app img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: none; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--surface-container); padding: 24px; border-radius: 24px; width: 90%; max-width: 400px; box-shadow: 0 8px 30px var(--shadow); }
        .modal-content h3 { margin-bottom: 16px; }
        .modal-content p { margin-bottom: 24px; color: var(--on-surface-variant); }
        .modal-content input { width: 100%; height: 48px; background-color: var(--surface-container-high); border: 1px solid var(--outline); border-radius: 8px; padding: 0 16px; margin-bottom: 16px; color: var(--on-surface); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 8px; }
        .modal-actions button { padding: 10px 24px; border-radius: 20px; border: none; cursor: pointer; font-weight: 500; }
        .modal-actions .primary-btn { background-color: var(--primary-color); color: var(--primary-container); }
        .modal-actions .secondary-btn { background-color: transparent; color: var(--primary-color); }
    </style>
</head>
<body>
    <div id="desktop"></div>
    <div id="contextMenu"></div>
    <div id="startMenu">
        <input type="text" id="search-box" placeholder="Search, apps, files...">
        <div class="app-grid">
            <div class="app-icon" data-app="files"><div class="icon-bg"><span class="material-symbols-outlined">folder_open</span></div><span>Files</span></div>
            <div class="app-icon" data-app="texts"><div class="icon-bg"><span class="material-symbols-outlined">edit_note</span></div><span>Texts</span></div>
            <div class="app-icon" data-app="numbers"><div class="icon-bg"><span class="material-symbols-outlined">calculate</span></div><span>Numbers</span></div>
            <div class="app-icon" data-app="settings"><div class="icon-bg"><span class="material-symbols-outlined">settings</span></div><span>Settings</span></div>
            <!-- Added Photos app to the start menu -->
            <div class="app-icon" data-app="photos"><div class="icon-bg"><span class="material-symbols-outlined">photo_library</span></div><span>Photos</span></div>
        </div>
    </div>
    <div id="taskbar">
        <button id="startButton"><span class="material-symbols-outlined">apps</span></button>
        <div id="taskbar-apps"></div>
        <div id="clock">12:00 PM</div>
    </div>
    <!-- MODALS -->
    <div id="saveDialog" class="modal-overlay">
        <div class="modal-content">
            <h3>Save File</h3>
            <p>Please enter the full path and filename.</p>
            <input type="text" id="savePathInput" placeholder="/home/user/filename.txt">
            <div class="modal-actions">
                <button class="secondary-btn" id="cancelSaveBtn">Cancel</button>
                <button class="primary-btn" id="confirmSaveBtn">Save</button>
            </div>
        </div>
    </div>
    <div id="confirmCloseDialog" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmCloseTitle">Unsaved Changes</h3>
            <p id="confirmCloseMessage">Do you want to save the changes you made?</p>
            <div class="modal-actions">
                <button class="secondary-btn" id="cancelCloseBtn">Cancel</button>
                <button class="secondary-btn" id="dontSaveBtn">Don't Save</button>
                <button class="primary-btn" id="saveAndCloseBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const desktop = document.getElementById('desktop');
        const startButton = document.getElementById('startButton');
        const startMenu = document.getElementById('startMenu');
        const clock = document.getElementById('clock');
        const taskbarApps = document.getElementById('taskbar-apps');
        const contextMenu = document.getElementById('contextMenu');
        const root = document.documentElement;

        let activeWindow = null;
        let highestZIndex = 100;
        const windowInstances = {}; // New object to track all app window instances
        const taskbarIconMap = {}; // New map to track taskbar icons
        let lastRightClickedElement = null;
        const WINDOW_MARGIN = 50; // Margin from viewport edges

        // --- DYNAMIC THEME GENERATION & APPLICATION ---
        const baseColors={'#6750a4':{light:{p:'#6750a4',pc:'#eaddff',opc:'#21005d',tc:'#ffd8e4',otc:'#31111d'},dark:{p:'#d0bcff',pc:'#4f378b',opc:'#eaddff',tc:'#efb8c8',otc:'#ffd8e4'}},'#00639b':{light:{p:'#00639b',pc:'#cfe5ff',opc:'#001d33',tc:'#e9def7',otc:'#251632'},dark:{p:'#9bcaff',pc:'#004a75',opc:'#cfe5ff',tc:'#e9def7',otc:'#524460'}},'#b3261e':{light:{p:'#b3261e',pc:'#f9dedc',opc:'#410002',tc:'#fdeee9',otc:'#2e140d'},dark:{p:'#f2b8b5',pc:'#93000a',opc:'#f9dedc',tc:'#fdeee9',otc:'#5f3f38'}},'#1b6c1f':{light:{p:'#1b6c1f',pc:'#a4f59a',opc:'#002203',tc:'#d4e7de',otc:'#0a1e16'},dark:{p:'#89d87f',pc:'#005312',opc:'#a4f59a',tc:'#d4e7de',otc:'#364b44'}}};
        function hexToHsl(H){let r=0,g=0,b=0;if(H.length==4){r="0x"+H[1]+H[1];g="0x"+H[2]+H[2];b="0x"+H[3]+H[3]}else if(H.length==7){r="0x"+H[1]+H[2];g="0x"+H[3]+H[4];b="0x"+H[5]+H[6]}r/=255;g/=255;b/=255;let cmin=Math.min(r,g,b),cmax=Math.max(r,g,b),delta=cmax-cmin,h=0,s=0,l=0;if(delta==0)h=0;else if(cmax==r)h=((g-b)/delta)%6;else if(cmax==g)h=(b-r)/delta+2;else h=(r-g)/delta+4;h=Math.round(h*60);if(h<0)h+=360;l=(cmax+cmin)/2;s=delta==0?0:delta/(1-Math.abs(2*l-1));s=+(s*100).toFixed(1);l=+(l*100).toFixed(1);return"hsl("+h+","+s+"%,"+l+"%)"}
        function hslToHex(h,s,l){s/=100;l/=100;let c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs((h/60)%2-1)),m=l-c/2,r=0,g=0,b=0;if(0<=h&&h<60){r=c;g=x;b=0}else if(60<=h&&h<120){r=x;g=c;b=0}else if(120<=h&&h<180){r=0;g=c;b=x}else if(180<=h&&h<240){r=0;g=x;b=c}else if(240<=h&&h<300){r=x;g=0;b=c}else if(300<=h&&h<360){r=c;g=0;b=x}r=Math.round((r+m)*255).toString(16);g=Math.round((g+m)*255).toString(16);b=Math.round((b+m)*255).toString(16);if(r.length==1)r="0"+r;if(g.length==1)g="0"+g;if(b.length==1)b="0"+b;return"#"+r+g+b}
        function generateTheme(baseHex){const isDark=document.body.classList.contains('dark-mode');const[h,s,l]=hexToHsl(baseHex).match(/\d+/g).map(Number);const theme={};const palette=isDark?baseColors[baseHex].dark:baseColors[baseHex].light;Object.assign(theme,{'--primary-color':palette.p,'--primary-container':palette.pc,'--on-primary-container':palette.opc,'--tertiary-container':palette.tc,'--on-tertiary-container':palette.otc});if(isDark){Object.assign(theme,{'--background':hslToHex(h,s*0.2,8),'--on-background':hslToHex(h,s*0.1,90),'--surface-container-low':hslToHex(h,s*0.2,12),'--surface-container':hslToHex(h,s*0.2,14),'--surface-container-high':hslToHex(h,s*0.2,18),'--on-surface':hslToHex(h,s*0.1,90),'--on-surface-variant':hslToHex(h,s*0.1,80),'--outline':hslToHex(h,s*0.1,60)})}else{Object.assign(theme,{'--background':hslToHex(h,s*0.3,98),'--on-background':hslToHex(h,s*0.2,10),'--surface-container-low':hslToHex(h,s*0.3,96),'--surface-container':hslToHex(h,s*0.3,94),'--surface-container-high':hslToHex(h,s*0.3,92),'--on-surface':hslToHex(h,s*0.2,10),'--on-surface-variant':hslToHex(h,s*0.15,30),'--outline':hslToHex(h,s*0.1,50)})}return theme}
        function applyTheme(baseHex){const theme=generateTheme(baseHex);for(const[key,value]of Object.entries(theme)){root.style.setProperty(key,value)}updateCssRgbVariables();updateWallpaper(theme)}
        function updateWallpaper(theme){const c1=encodeURIComponent(theme['--primary-container']);const c2=encodeURIComponent(theme['--primary-color']);const opacity=document.body.classList.contains('dark-mode')?0.2:0.1;const svgUrl=`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,100 Q50,0 100,100 Z" fill="${c1}" opacity="${opacity}" /><path d="M0,0 Q50,100 100,0 Z" fill="${c2}" opacity="${opacity}" /></svg>')`;desktop.style.backgroundImage=svgUrl}
        function hexToRgb(hex){let result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?`${parseInt(result[1],16)}, ${parseInt(result[2],16)}, ${parseInt(result[3],16)}`:'0,0,0'}
        function updateCssRgbVariables(){const style=getComputedStyle(root);const high=style.getPropertyValue('--surface-container-high').trim();const container=style.getPropertyValue('--surface-container').trim();const low=style.getPropertyValue('--surface-container-low').trim();const outline=style.getPropertyValue('--outline').trim();const onSurface=style.getPropertyValue('--on-surface').trim();root.style.setProperty('--surface-container-high-rgb',hexToRgb(high));root.style.setProperty('--surface-container-rgb',hexToRgb(container));root.style.setProperty('--surface-container-low-rgb',hexToRgb(low));root.style.setProperty('--outline-rgb',hexToRgb(outline));root.style.setProperty('--on-surface-rgb',hexToRgb(onSurface))}

        // --- CORE OS & WINDOW MANAGEMENT ---
        function updateClock(){clock.textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
        setInterval(updateClock,1000);updateClock();
        function toggleStartMenu(){startMenu.classList.toggle('show');startButton.classList.toggle('active')}
        startButton.addEventListener('click',e=>{e.stopPropagation();toggleStartMenu()});
        
        function focusWindow(windowEl){
            if(activeWindow===windowEl) return;
            // Un-active all current windows
            Object.values(windowInstances).flat().forEach(win => win.classList.remove('active'));
            // Un-active all taskbar icons
            Object.values(taskbarIconMap).forEach(iconEl => iconEl.classList.remove('active'));
            
            highestZIndex++;
            windowEl.style.zIndex=highestZIndex;
            windowEl.classList.add('active');
            activeWindow=windowEl;
            
            const taskbarIcon = taskbarIconMap[windowEl.dataset.app];
            if (taskbarIcon) {
                taskbarIcon.classList.add('active');
            }
        }

        function makeWindowDraggable(windowEl){
            const titleBar=windowEl.querySelector('.title-bar');
            let isDragging=false,offset={x:0,y:0};
            titleBar.addEventListener('mousedown',e=>{
                if(e.target.closest('.window-control'))return;
                e.preventDefault();
                isDragging=true;
                offset={x:e.clientX-windowEl.offsetLeft,y:e.clientY-windowEl.offsetTop};
                titleBar.style.cursor='grabbing';
                focusWindow(windowEl);
            });
            document.addEventListener('mousemove',e=>{
                if(!isDragging)return;
                windowEl.style.top=`${e.clientY-offset.y}px`;
                windowEl.style.left=`${e.clientX-offset.x}px`;
            });
            document.addEventListener('mouseup',()=>{
                isDragging=false;
                titleBar.style.cursor='grab';
            });
        }

        // --- SIMULATED FILE SYSTEM ---
        const fileSystem = {
            '/': { type: 'directory', children: {
                'home': { type: 'directory', children: { 'user': { type: 'directory', children: {
                    'Documents': { type: 'directory', children: { 'report.txt': { type: 'file', content: 'Project Status Report:\n\n- Phase 1: Complete\n- Phase 2: In Progress\n- Phase 3: Pending' } } },
                    'Pictures': { type: 'directory', children: { 'vacation.jpg': { type: 'file', content: 'https://placehold.co/1280x720/6750a4/FFFFFF?text=Vacation+Photo' } } },
                    'welcome.txt': { type: 'file', content: 'UNDER CONSTRUCTION!' }
                }}}},
                'bin': { type: 'directory', children: { 'bash': {type: 'file', content: '#!/bin/bash'}, 'ls': {type: 'file', content: '# list command'} } },
                'etc': { type: 'directory', children: { 'hosts': {type: 'file', content: '127.0.0.1 localhost'}, 'fstab': {type: 'file', content: '# /etc/fstab'} } },
            }}
        };
        const getObjectByPath = path => { const parts = path.split('/').filter(p => p); let current = fileSystem['/']; for (const part of parts) { if (current && current.children && current.children[part]) { current = current.children[part]; } else { return null; } } return current; };

        // --- APP DEFINITIONS ---
        const appData = {
            texts: {title:'Texts',icon:'edit_note',content:`<div class="texts-app"><textarea></textarea></div>`, defaultSize: {width: 450, height: 550}, minSize: {width: 450, height: 400}},
            settings: {title:'Settings',icon:'settings',content:`<div class="settings-app"><div class="setting-item"><label>Accent Color</label><div class="color-palette"><div class="color-dot active" style="background-color:#6750a4;" data-color="#6750a4"></div><div class="color-dot" style="background-color:#00639b;" data-color="#00639b"></div><div class="color-dot" style="background-color:#b3261e;" data-color="#b3261e"></div><div class="color-dot" style="background-color:#1b6c1f;" data-color="#1b6c1f"></div></div></div><div class="setting-item"><label>Dark Mode</label><label class="switch"><input type="checkbox" id="darkModeToggle"><span class="slider"></span></label></div></div>`, defaultSize: {width: 450, height: 550}, minSize: {width: 300, height: 300}},
            numbers: {title:'Numbers',icon:'calculate',content:`<div class="numbers-app"><div class="calculator-display">0</div><div class="calculator-buttons"><button class="calc-btn operator" data-key="clear">C</button><button class="calc-btn operator" data-key="backspace">⌫</button><button class="calc-btn operator" data-key="%">%</button><button class="calc-btn operator" data-key="/">÷</button><button class="calc-btn" data-key="7">7</button><button class="calc-btn" data-key="8">8</button><button class="calc-btn" data-key="9">9</button><button class="calc-btn operator" data-key="*">×</button><button class="calc-btn" data-key="4">4</button><button class="calc-btn" data-key="5">5</button><button class="calc-btn" data-key="6">6</button><button class="calc-btn operator" data-key="-">-</button><button class="calc-btn" data-key="1">1</button><button class="calc-btn" data-key="2">2</button><button class="calc-btn" data-key="3">3</button><button class="calc-btn operator" data-key="+">+</button><button class="calc-btn" data-key="0">0</button><button class="calc-btn" data-key=".">.</button><button class="calc-btn equals" data-key="=">=</button></div></div>`, defaultSize: {width: 350, height: 500}, minSize: {width: 350, height: 500}},
            files: { title: 'Files', icon: 'folder_open', content: `<div class="files-app">
                <div class="files-toolbar">
                    <button class="toolbar-btn" id="back-btn" disabled><span class="material-symbols-outlined">arrow_back</span></button>
                    <button class="toolbar-btn" id="forward-btn" disabled><span class="material-symbols-outlined">arrow_forward</span></button>
                    <button class="toolbar-btn" id="up-btn"><span class="material-symbols-outlined">arrow_upward</span></button>
                    <div class="path-bar"></div>
                    <div class="view-toggle">
                        <button class="toolbar-btn active" data-view="grid"><span class="material-symbols-outlined">grid_view</span></button>
                        <button class="toolbar-btn" data-view="list"><span class="material-symbols-outlined">view_list</span></button>
                    </div>
                </div>
                <div class="files-content-area">
                    <div class="files-sidebar">
                        <div class="sidebar-item" data-path="/home/user"><span class="material-symbols-outlined">home</span>Home</div>
                        <div class="sidebar-item" data-path="/"><span class="material-symbols-outlined">database</span>Root</div>
                    </div>
                    <div class="file-view-container" id="file-view-container"></div>
                    <div class="files-details-pane"></div>
                </div>
            </div>`, defaultSize: {width: 1000, height: 700}, minSize: {width: 650, height: 500}},
            photos: { title: 'Photos', icon: 'photo_library', content: `<div class="photos-app"><img src="" alt="Image Content"></div>`, defaultSize: {width: 800, height: 600}, minSize: {width: 450, height: 350}}
        };

        function createApp(appId, launchData = {}){
            const app = appData[appId];
            const instanceId = `${appId}-${Date.now()}`;
            
            const windowEl = document.createElement('div');
            windowEl.className = 'window';
            windowEl.dataset.app = appId;
            windowEl.dataset.instanceId = instanceId;
            
            if (appId === 'texts') {
                windowEl.filePath = null;
                windowEl.isDirty = false;
                windowEl.initialContent = '';
            }

            // Set min-width and min-height based on app data
            windowEl.style.minWidth = `${app.minSize.width}px`;
            windowEl.style.minHeight = `${app.minSize.height}px`;

            // Calculate a random but reasonable size and position
            const windowWidth = app.defaultSize.width;
            const windowHeight = app.defaultSize.height;

            const maxPosX = window.innerWidth - windowWidth - WINDOW_MARGIN;
            const maxPosY = window.innerHeight - windowHeight - WINDOW_MARGIN - 56;
            const startX = Math.random() * (maxPosX - WINDOW_MARGIN) + WINDOW_MARGIN;
            const startY = Math.random() * (maxPosY - WINDOW_MARGIN) + WINDOW_MARGIN;

            windowEl.style.width = `${windowWidth}px`;
            windowEl.style.height = `${windowHeight}px`;
            windowEl.style.left = `${startX}px`;
            windowEl.style.top = `${startY}px`;
            
            windowEl.innerHTML=`<div class="title-bar"><span class="material-symbols-outlined title-bar-icon">${app.icon}</span><span class="title-bar-text">${app.title}</span><div class="window-controls"><button class="window-control minimize-btn"><span class="material-symbols-outlined">minimize</span></button><button class="window-control maximize-btn"><span class="material-symbols-outlined">check_box_outline_blank</span></button><button class="window-control close-btn"><span class="material-symbols-outlined">close</span></button></div></div><div class="window-body">${app.content}</div>`;
            desktop.appendChild(windowEl);
            
            // Add instance to the new windowInstances map
            if (!windowInstances[appId]) {
                windowInstances[appId] = [];
            }
            windowInstances[appId].push(windowEl);

            // Create or update taskbar icon
            let taskbarIcon = taskbarIconMap[appId];
            if (!taskbarIcon) {
                taskbarIcon = document.createElement('div');
                taskbarIcon.className = 'taskbar-app';
                taskbarIcon.dataset.app = appId;
                taskbarIcon.innerHTML = `<span class="material-symbols-outlined taskbar-icon">${app.icon}</span>`;
                taskbarApps.appendChild(taskbarIcon);
                taskbarIconMap[appId] = taskbarIcon;

                // Add event listeners to the taskbar icon
                taskbarIcon.addEventListener('click', (e) => {
                    const instances = windowInstances[appId];
                    if (instances && instances.length > 0) {
                        const anyVisible = instances.some(win => win.style.display !== 'none');

                        if (anyVisible) {
                            // Minimize all windows for this app
                            instances.forEach(win => {
                                if (win.style.display !== 'none') {
                                    win.classList.remove('restoring');
                                    win.classList.add('minimized');
                                    win.addEventListener('animationend', () => {
                                        win.style.display = 'none';
                                    }, { once: true });
                                    if(activeWindow === win) activeWindow = null;
                                }
                            });
                            taskbarIcon.classList.remove('active');
                        } else {
                           // Restore all windows for this app
                            instances.forEach(win => {
                                win.style.display = 'flex';
                                win.classList.remove('minimized');
                                
                                // This ensures the browser has processed the 'display: flex'
                                // but hasn't had time to render the full-size window before the
                                // animation class is applied, preventing the flash.
                                requestAnimationFrame(() => {
                                    win.classList.add('restoring');
                                });

                                win.addEventListener('animationend', () => {
                                    win.classList.remove('restoring');
                                }, { once: true });
                            });
                            focusWindow(instances[0]);
                        }
                    }
                });
                taskbarIcon.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showContextMenu(e, 'taskbar');
                });
            }
            
            // Update app count badge
            const appCount = windowInstances[appId].length;
            if (appCount > 1) {
                let badge = taskbarIcon.querySelector('.app-count-badge');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'app-count-badge';
                    taskbarIcon.appendChild(badge);
                }
                badge.textContent = appCount;
            } else {
                taskbarIcon.querySelector('.app-count-badge')?.remove();
            }

            focusWindow(windowEl);
            makeWindowDraggable(windowEl);
            addWindowEventListeners(windowEl);
            
            if(appId==='settings')initSettingsApp(windowEl);
            if(appId==='numbers')initNumbersApp(windowEl);
            if(appId==='files')initFilesApp(windowEl);
            if(appId==='texts')initTextsApp(windowEl);
            
            return windowEl;
        }

        // --- WINDOW CLOSE LOGIC (MODIFIED FOR TEXTS APP) ---
        function closeWindow(windowEl) {
            windowEl.classList.add('closing');
            windowEl.addEventListener('animationend', () => {
                desktop.removeChild(windowEl);
                const appId = windowEl.dataset.app;
                const instanceId = windowEl.dataset.instanceId;
                
                // Remove from the new windowInstances map
                const instances = windowInstances[appId];
                if (instances) {
                    const index = instances.findIndex(win => win.dataset.instanceId === instanceId);
                    if (index > -1) {
                        instances.splice(index, 1);
                    }
                }
                
                // Remove taskbar icon if it's the last instance
                if (windowInstances[appId].length === 0) {
                    taskbarIconMap[appId]?.remove();
                    delete taskbarIconMap[appId];
                    delete windowInstances[appId];
                } else {
                    const appCount = windowInstances[appId].length;
                    const taskbarIcon = taskbarIconMap[appId];
                    if (appCount > 1) {
                        taskbarIcon.querySelector('.app-count-badge').textContent = appCount;
                    } else {
                        taskbarIcon.querySelector('.app-count-badge')?.remove();
                    }
                }
            }, { once: true });
        }
        function addWindowEventListeners(windowEl){const appId=windowEl.dataset.app;windowEl.querySelector('.close-btn').addEventListener('click',()=>{
            if(appId === 'texts' && windowEl.isDirty) {
                showConfirmCloseDialog(windowEl);
            } else { closeWindow(windowEl); }
        });
        let originalState={};const maximizeBtn=windowEl.querySelector('.maximize-btn');maximizeBtn.addEventListener('click',()=>{
            if(windowEl.classList.toggle('maximized')){
                originalState={top:windowEl.style.top,left:windowEl.style.left,width:windowEl.style.width,height:windowEl.style.height};
                maximizeBtn.innerHTML=`<span class="material-symbols-outlined">fullscreen_exit</span>`;
                windowEl.classList.remove('restoring');
            }else{
                Object.assign(windowEl.style,originalState);
                maximizeBtn.innerHTML=`<span class="material-symbols-outlined">check_box_outline_blank</span>`;
            }
        });
        windowEl.querySelector('.minimize-btn').addEventListener('click',()=>{
            windowEl.classList.remove('restoring');
            windowEl.classList.add('minimized');
            taskbarIconMap[appId]?.classList.remove('active');
            windowEl.addEventListener('animationend', () => {
                windowEl.style.display = 'none';
            }, {once: true});
            if(activeWindow===windowEl)activeWindow=null;
        });
        windowEl.addEventListener('mousedown',()=>focusWindow(windowEl),true)}
        document.querySelectorAll('.app-icon').forEach(icon=>{icon.addEventListener('click',()=>{createApp(icon.dataset.app);if(startMenu.classList.contains('show'))toggleStartMenu()})});
        document.querySelectorAll('.app-icon').forEach(icon => {
            icon.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showContextMenu(e, 'start-menu');
            });
        });
        
        // --- APP-SPECIFIC LOGIC ---
        function initSettingsApp(windowEl){const darkModeToggle=windowEl.querySelector('#darkModeToggle');darkModeToggle.checked=document.body.classList.contains('dark-mode');const changeTheme=()=>{applyTheme(windowEl.querySelector('.color-dot.active').dataset.color)};windowEl.querySelectorAll('.color-dot').forEach(dot=>{dot.addEventListener('click',()=>{windowEl.querySelector('.color-dot.active').classList.remove('active');dot.classList.add('active');changeTheme()})});darkModeToggle.addEventListener('change',()=>{document.body.classList.toggle('dark-mode');changeTheme()})}
        function initNumbersApp(windowEl){const display=windowEl.querySelector('.calculator-display'),buttons=windowEl.querySelectorAll('.calc-btn');let currentInput='0',operator=null,previousInput=null,shouldResetDisplay=false;buttons.forEach(button=>button.addEventListener('click',()=>{const key=button.dataset.key;if(key>='0'&&key<='9'){if(currentInput==='0'||shouldResetDisplay){currentInput=key;shouldResetDisplay=false}else{currentInput+=key}}else if(key==='.'){if(!currentInput.includes('.'))currentInput+='.'}else if(['+','-','*','/'].includes(key)){if(operator&&!shouldResetDisplay)calculate();operator=key;previousInput=currentInput;shouldResetDisplay=true}else if(key==='='){calculate();operator=null}else if(key==='clear'){currentInput='0';operator=null;previousInput=null}else if(key==='backspace'){currentInput=currentInput.slice(0,-1)||'0'}else if(key==='%'){currentInput=(parseFloat(currentInput)/100).toString()}
        display.textContent=currentInput}));function calculate(){if(!operator||previousInput===null)return;let result;switch(operator){case'+':result=parseFloat(previousInput)+parseFloat(currentInput);break;case'-':result=parseFloat(previousInput)-parseFloat(currentInput);break;case'*':result=parseFloat(previousInput)*parseFloat(currentInput);break;case'/':result=parseFloat(previousInput)/parseFloat(currentInput);break}
        currentInput=String(Number(result.toPrecision(12)));shouldResetDisplay=true}}
        
        function initFilesApp(windowEl) {
            const pathBar = windowEl.querySelector('.path-bar');
            const fileViewContainer = windowEl.querySelector('#file-view-container');
            const sidebar = windowEl.querySelector('.files-sidebar');
            const detailsPane = windowEl.querySelector('.files-details-pane');
            const backBtn = windowEl.querySelector('#back-btn');
            const forwardBtn = windowEl.querySelector('#forward-btn');
            const upBtn = windowEl.querySelector('#up-btn');
            const viewToggleBtns = windowEl.querySelectorAll('.view-toggle .toolbar-btn');

            let currentPath = '/home/user';
            let selectedItemPath = null;
            let currentView = 'grid'; // 'grid' or 'list'
            let history = [currentPath];
            let historyIndex = 0;

            const updateNavButtons = () => {
                backBtn.disabled = historyIndex === 0;
                forwardBtn.disabled = historyIndex === history.length - 1;
                upBtn.disabled = currentPath === '/';
            };

            const navigate = (path, addToHistory = true) => {
                const dir = getObjectByPath(path);
                if (!dir || dir.type !== 'directory') return;
                currentPath = path;
                selectedItemPath = null;
                render();
                if (addToHistory) {
                    history.splice(historyIndex + 1);
                    history.push(currentPath);
                    historyIndex = history.length - 1;
                }
                updateNavButtons();
            };

            const renderPathBar = () => {
                pathBar.innerHTML = '';
                const segments = currentPath === '/' ? [''] : currentPath.split('/').filter(p => p);
                let currentBuildPath = '';
                segments.forEach((segment, index) => {
                    const name = index === 0 && segment === '' ? '/' : segment;
                    currentBuildPath = currentBuildPath + '/' + segment;
                    
                    const el = document.createElement('span');
                    el.className = 'path-segment';
                    el.textContent = name === '' ? '/' : name;
                    el.dataset.path = currentBuildPath === '' ? '/' : currentBuildPath;
                    pathBar.appendChild(el);
                    if (index < segments.length - 1) {
                        const sep = document.createElement('span');
                        sep.className = 'path-separator';
                        sep.textContent = '›';
                        pathBar.appendChild(sep);
                    }
                });
            };

            const renderDetails = () => {
                if (!selectedItemPath) {
                    detailsPane.innerHTML = `<div class="details-placeholder"><span class="material-symbols-outlined">touch_app</span><span>Select an item to see details.</span></div>`;
                    return;
                }
                const item = getObjectByPath(selectedItemPath);
                if (!item) return;
                const name = selectedItemPath.split('/').pop();
                const icon = item.type === 'directory' ? 'folder' : 'description';
                
                let previewHtml = '';
                if (item.type === 'file' && item.content && (item.content.startsWith('data:image') || item.content.startsWith('http'))) {
                    previewHtml = `<img src="${item.content}" alt="Preview" class="details-preview">`;
                }

                detailsPane.innerHTML = `
                    <div class="details-content">
                        <span class="material-symbols-outlined">${icon}</span>
                        <h4>${name}</h4>
                        <dl>
                            <dt>Type:</dt><dd>${item.type}</dd>
                            <dt>Path:</dt><dd>${selectedItemPath}</dd>
                        </dl>
                        ${previewHtml}
                    </div>`;
            };

            const render = () => {
                const dir = getObjectByPath(currentPath);
                if (!dir || dir.type !== 'directory') return;
                
                renderPathBar();
                fileViewContainer.innerHTML = '';
                const container = document.createElement('div');
                container.className = currentView === 'grid' ? 'file-grid-view' : 'file-list-view';
                
                const sortedChildren = Object.entries(dir.children || {}).sort(([aName, aItem], [bName, bItem]) => {
                    if (aItem.type === bItem.type) return aName.localeCompare(bName);
                    return aItem.type === 'directory' ? -1 : 1;
                });

                sortedChildren.forEach(([name, item]) => {
                    const itemPath = `${currentPath === '/' ? '' : currentPath}/${name}`;
                    const el = document.createElement('div');
                    el.dataset.type = item.type;
                    el.dataset.path = itemPath;
                    const icon = item.type === 'directory' ? 'folder' : 'description';

                    if (currentView === 'grid') {
                        el.className = 'file-item';
                        el.innerHTML = `<span class="material-symbols-outlined">${icon}</span><span>${name}</span>`;
                    } else { // list view
                        el.className = 'file-list-item';
                        el.innerHTML = `
                            <span class="material-symbols-outlined">${icon}</span>
                            <span class="file-name">${name}</span>
                            <span class="file-type">${item.type}</span>`;
                    }
                    if (itemPath === selectedItemPath) el.classList.add('selected');
                    container.appendChild(el);
                });
                fileViewContainer.appendChild(container);
                renderDetails();
                
                sidebar.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.path === currentPath);
                });
            };
            
            // Event Listeners
            fileViewContainer.addEventListener('click', e => {
                const itemEl = e.target.closest('.file-item, .file-list-item');
                fileViewContainer.querySelectorAll('.selected').forEach(sel => sel.classList.remove('selected'));
                if (itemEl) {
                    itemEl.classList.add('selected');
                    selectedItemPath = itemEl.dataset.path;
                } else {
                    selectedItemPath = null;
                }
                renderDetails();
            });

            fileViewContainer.addEventListener('dblclick', e => {
                const itemEl = e.target.closest('.file-item, .file-list-item');
                if (!itemEl) return;
                
                if (itemEl.dataset.type === 'directory') {
                    navigate(itemEl.dataset.path);
                } else {
                    const file = getObjectByPath(itemEl.dataset.path);
                    if (!file) return;
                    const extension = itemEl.dataset.path.split('.').pop();
                    if (extension === 'jpg' || extension === 'jpeg' || extension === 'png') {
                        openFileInViewer(itemEl.dataset.path, file.content);
                    } else {
                        openFileInEditor(itemEl.dataset.path, file.content);
                    }
                }
            });

            pathBar.addEventListener('click', e => {
                const segment = e.target.closest('.path-segment');
                if (segment && segment.dataset.path !== currentPath) {
                    navigate(segment.dataset.path);
                }
            });

            sidebar.addEventListener('click', e => {
                const item = e.target.closest('.sidebar-item');
                if (item && item.dataset.path !== currentPath) {
                    navigate(item.dataset.path);
                }
            });

            viewToggleBtns.forEach(btn => btn.addEventListener('click', () => {
                viewToggleBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                render();
            }));

            backBtn.addEventListener('click', () => { if (historyIndex > 0) { historyIndex--; navigate(history[historyIndex], false); } });
            forwardBtn.addEventListener('click', () => { if (historyIndex < history.length - 1) { historyIndex++; navigate(history[historyIndex], false); } });
            upBtn.addEventListener('click', () => {
                if (currentPath !== '/') {
                    const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
                    navigate(parentPath);
                }
            });
            
            navigate(currentPath, true); // Initial render
        }

        function initTextsApp(windowEl) { const textarea = windowEl.querySelector('textarea'); const titleText = windowEl.querySelector('.title-bar-text'); textarea.addEventListener('input', () => { windowEl.isDirty = textarea.value !== windowEl.initialContent; titleText.textContent = `Texts - ${windowEl.filePath ? windowEl.filePath.split('/').pop() : 'Untitled'}${windowEl.isDirty ? '*' : ''}`; }); }

        // --- FILE HANDLING & SAVING LOGIC ---
        function openFileInEditor(path, content) {
            const textsWindow = createApp('texts');
            const textarea = textsWindow.querySelector('textarea');
            const titleText = textsWindow.querySelector('.title-bar-text');
            textarea.value = content;
            textsWindow.filePath = path;
            textsWindow.initialContent = content;
            textsWindow.isDirty = false;
            titleText.textContent = `Texts - ${path.split('/').pop()}`;
            focusWindow(textsWindow);
        }
        function openFileInViewer(path, content) {
            const photosWindow = createApp('photos');
            const img = photosWindow.querySelector('img');
            const titleText = photosWindow.querySelector('.title-bar-text');
            img.src = content;
            titleText.textContent = `Photos - ${path.split('/').pop()}`;
        }
        function saveFile(path, content) {
            const parts = path.split('/').filter(p => p);
            const filename = parts.pop();
            const parentPath = '/' + parts.join('/');
            const parentDir = getObjectByPath(parentPath);
            if (parentDir && parentDir.type === 'directory') {
                const existingFile = parentDir.children[filename];
                if (existingFile && existingFile.type === 'file') {
                    existingFile.content = content; // Update existing
                } else {
                    parentDir.children[filename] = { type: 'file', content: content }; // Create new
                }
                return true;
            }
            return false;
        }
        const saveDialog = document.getElementById('saveDialog');
        const confirmCloseDialog = document.getElementById('confirmCloseDialog');
        let activeSaveContext = null;

        function showSaveDialog(textsWindow) {
            activeSaveContext = textsWindow;
            saveDialog.querySelector('#savePathInput').value = textsWindow.filePath || '/home/user/untitled.txt';
            saveDialog.style.display = 'flex';
        }
        function showConfirmCloseDialog(textsWindow) {
            activeSaveContext = textsWindow;
            confirmCloseDialog.style.display = 'flex';
        }
        document.getElementById('cancelSaveBtn').addEventListener('click', () => saveDialog.style.display = 'none');
        document.getElementById('confirmSaveBtn').addEventListener('click', () => {
            const path = document.getElementById('savePathInput').value;
            const content = activeSaveContext.querySelector('textarea').value;
            if (saveFile(path, content)) {
                activeSaveContext.filePath = path;
                activeSaveContext.initialContent = content;
                activeSaveContext.isDirty = false;
                activeSaveContext.querySelector('.title-bar-text').textContent = `Texts - ${path.split('/').pop()}`;
                saveDialog.style.display = 'none';
            } else { alert('Invalid path! Could not save file.'); }
        });
        document.getElementById('cancelCloseBtn').addEventListener('click', () => confirmCloseDialog.style.display = 'none');
        document.getElementById('dontSaveBtn').addEventListener('click', () => { closeWindow(activeSaveContext); confirmCloseDialog.style.display = 'none'; });
        document.getElementById('saveAndCloseBtn').addEventListener('click', () => {
            if (activeSaveContext.filePath) {
                saveFile(activeSaveContext.filePath, activeSaveContext.querySelector('textarea').value);
                closeWindow(activeSaveContext);
            } else { showSaveDialog(activeSaveContext); }
            confirmCloseDialog.style.display = 'none';
        });

        // --- CONTEXT MENU LOGIC ---
        function showContextMenu(e, type) {
            e.preventDefault();
            hideContextMenu();
            lastRightClickedElement = e.target;
            let menuItems = [];
            
            if (type === 'start-menu') {
                const appIcon = e.target.closest('.app-icon');
                const appId = appIcon.dataset.app;
                const appTitle = appData[appId].title;
                menuItems = [
                    { label: `Open ${appTitle}`, action: `open-new-instance-${appId}`, icon: 'open_in_new' }
                ];
            } else if (type === 'taskbar') {
                const taskbarIcon = e.target.closest('.taskbar-app');
                const appId = taskbarIcon.dataset.app;
                const appTitle = appData[appId].title;
                const instances = windowInstances[appId];
                if (!instances || instances.length === 0) return;

                if (instances.length > 1) {
                    menuItems = [
                        { label: `Open New`, action: `open-new-instance-${appId}`, icon: 'open_in_new' },
                        { type: 'separator' },
                        { label: `Close all instances`, action: `close-all-instances-${appId}`, icon: 'close' }
                    ];
                } else {
                    menuItems = [
                        { label: `Open New`, action: `open-new-instance-${appId}`, icon: 'open_in_new' },
                        { type: 'separator' },
                        { label: `Close`, action: `close-single-instance-${appId}`, icon: 'close' }
                    ];
                }
            } else if (e.target.closest('.title-bar')){
                menuItems=[{label:'Minimize',action:'minimize-window',icon:'minimize'},{label:'Maximize',action:'maximize-window',icon:'check_box_outline_blank'},{type:'separator'},{label:'Close',action:'close-window',icon:'close'}];
            } else if(e.target.matches('.texts-app textarea')){
                menuItems=[{label:'Save',action:'save-text',icon:'save'},{type:'separator'},{label:'Copy',action:'copy',icon:'content_copy'},{label:'Paste',action:'paste',icon:'content_paste'},{label:'Select All',action:'select-all',icon:'select_all'}];
            } else if(!e.target.closest('.window')){
                menuItems=[{label:'New Folder',action:'demo',icon:'create_new_folder'},{label:'Change Wallpaper',action:'demo',icon:'wallpaper'}];
            }

            if(menuItems.length > 0) {
                const menuHtml='<ul>'+menuItems.map(item=>item.type==='separator'?'<hr>':`<li data-action="${item.action}"><span class="material-symbols-outlined">${item.icon}</span>${item.label}</li>`).join('')+'</ul>';
                contextMenu.innerHTML=menuHtml;
                const{clientX:mouseX,clientY:mouseY}=e;
                const{innerWidth,innerHeight}=window;
                const{offsetWidth:menuWidth,offsetHeight:menuHeight}=contextMenu;
                contextMenu.style.left=(mouseX+menuWidth>innerWidth?innerWidth-menuWidth-5:mouseX)+'px';
                contextMenu.style.top=(mouseY+menuHeight>innerHeight?innerHeight-menuHeight-5:mouseY)+'px';
                contextMenu.classList.add('visible');
            }
        }

        function hideContextMenu(){contextMenu.classList.remove('visible')}
        
        async function handleContextMenuAction(e){
            const li = e.target.closest('li');
            if (!li) return;
            const fullAction = li.dataset.action;
            const targetWindow = lastRightClickedElement.closest('.window');
            
            // New, robust action parsing
            let action = fullAction;
            let appId = null;
            const prefixes = ['open-new-instance-', 'close-all-instances-', 'close-single-instance-'];
            const matchingPrefix = prefixes.find(p => fullAction.startsWith(p));
            if (matchingPrefix) {
                action = matchingPrefix.slice(0, -1);
                appId = fullAction.substring(matchingPrefix.length);
            }

            switch(action){
                case 'open-new-instance':
                    createApp(appId);
                    break;
                case 'copy':
                    document.execCommand('copy');
                    break;
                case 'select-all':
                    lastRightClickedElement?.select();
                    break;
                case 'paste':
                    try {
                        const text = await navigator.clipboard.readText();
                        lastRightClickedElement.focus();
                        document.execCommand('insertText', false, text);
                    } catch(err) {
                        console.error('Paste failed: ', err);
                    }
                    break;
                case 'save-text':
                    if (targetWindow.filePath) {
                        saveFile(targetWindow.filePath, targetWindow.querySelector('textarea').value);
                        targetWindow.initialContent = targetWindow.querySelector('textarea').value;
                        targetWindow.isDirty = false;
                        targetWindow.querySelector('.title-bar-text').textContent = `Texts - ${targetWindow.filePath.split('/').pop()}`;
                    } else {
                        showSaveDialog(targetWindow);
                    }
                    break;
                case 'minimize-window':
                    targetWindow.querySelector('.minimize-btn').click();
                    break;
                case 'maximize-window':
                    targetWindow.querySelector('.maximize-btn').click();
                    break;
                case 'close-window':
                    targetWindow.querySelector('.close-btn').click();
                    break;
                case 'close-all-instances':
                    const instancesToClose = windowInstances[appId];
                    if (instancesToClose) {
                        [...instancesToClose].forEach(win => closeWindow(win));
                    }
                    break;
                case 'close-single-instance':
                    const instanceToClose = windowInstances[appId];
                    if (instanceToClose && instanceToClose.length > 0) {
                        closeWindow(instanceToClose[0]);
                    }
                    break;
                case 'demo':
                    console.log("Demo action clicked. This is for demonstration purposes.");
                    break;
            }
            hideContextMenu();
        }

        // --- GLOBAL EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('contextmenu',showContextMenu);
        document.addEventListener('click',e=>{if(!startMenu.contains(e.target)&&!startButton.contains(e.target)&&startMenu.classList.contains('show')){toggleStartMenu()}if(!contextMenu.contains(e.target)){hideContextMenu()}});
        contextMenu.addEventListener('click',handleContextMenuAction);

        applyTheme('#6750a4');
    });
    </script>
</body>
</html>

